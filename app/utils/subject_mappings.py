"""
Subject name mappings for converting unfriendly subject codes/names to friendly display names.
Different mappings for different year groups (S3, S4, S5-6).
"""

# S3 Subject Mappings
S3_SUBJECT_MAPPINGS = {
    # Add mappings here as you discover them
    # Example format:
    # 'UNFRIENDLY_NAME': 'Friendly Name',
    # 'MATH_ADV': 'Mathematics Advanced',
    # 'ENG_LIT': 'English Literature',
    'ARTZ ArtZ CfE': 'Art',
    'ASPX SpaX CfE': 'Spanish (ASN)',
    'BIOX BiolX CfE': 'Biology',
    'CHEX ChemX CfE': 'Chemistry',
    'DANZ Dance CfE': 'Dance',
    'DRAZ DraZ CfE': 'Drama',
    'ELS3 ELS3 CfE': 'Enhanced Language Skills',
    'FREZ FreZ CfE': 'French',
    'FSKL FutSk CfE': 'Future Skills',
    'GEOZ GeogZ CfE': 'Geography',
    'HISZ HistZ CfE': 'History',
    'ITAC ITAcc CfE': 'Accounting',
    'ITAD ICTAd CfE': 'Admin and IT',
    'ITBM ICTBM CfE': 'Business Management',
    'ITCS ICTCS CfE': 'Computing Science',
    'MANZ ManZ CfE': 'Mandarin',
    'MODZ ModZ CfE': 'Modern Studies',
    'MUSZ MusZ CfE': 'Music',
    'MatX MatX CfE': 'Mathematics',
    'PDAW PerDv CfE': 'Personal Development',
    'PHYX PhysX CfE': 'Physics',
    'RMPX RMPSx CfE': 'RMPS',
    'SPAZ SpanZ CfE': 'Spanish',
    'TSDM TSDM CfE': 'Design and Manufacture',
    'TSGC TSGC CfE': 'Graphic Communication',
    'TSPM TSPM CfE': 'Practical Metalwork',
    'TSPW TSPW CfE': 'Practical Woodwork',
    'Accounting': 'Accounting',
    'Administration and IT': 'Administration and IT',
    'Art': 'Art',
    'Biology': 'Biology',
    'Business Management': 'Business Management',
    'Chemistry': 'Chemistry',
    'Computing Science': 'Computing Science',
    'Dance': 'Dance',
    'Design and Manufacture': 'Design and Manufacture',
    'Drama': 'Drama',
    'Enhanced Language Skills': 'Enhanced Language Skills',
    'Fashion and Textiles': 'Fashion and Textiles',
    'French': 'French',
    'Geography': 'Geography',
    'Graphic Communication': 'Graphic Communication',
    'History': 'History',
    'Mandarin': 'Mandarin',
    'Metalwork': 'Metalwork',
    'Modern Studies': 'Modern Studies',
    'Music': 'Music',
    'Physics': 'Physics',
    'Spanish': 'Spanish',
    'Woodwork': 'Practical Woodwork',
    'Accounting': 'Accounting',
    'Admin and IT': 'Admin and IT',
    'Art': 'Art',
    'Arts': 'Arts',
    'Biology': 'Biology',
    'Business Management': 'Business Management',
    'Chemistry': 'Chemistry',
    'Computing Science': 'Computing Science',
    'Dance': 'Dance',
    'Drama': 'Drama',
    'Economics': 'Economics',
    'Fashion and Textiles': 'Fashion and Textiles',
    'Future Skills and IDL': 'Future Skills and IDL',
    'Geography': 'Geography',
    'Graphic Communication': 'Graphic Communication',
    'History': 'History',
    'Home Economics': 'Home Economics',
    'Literacy': 'Literacy',
    'Modern Studies': 'Modern Studies',
    'Music': 'Music',
    'Physics': 'Physics',
    'Practical Metalwork': 'Practical Metalwork',
    'Practical Woodwork': 'Practical Woodwork',
    'Science': 'Science',
    'Social Subjects': 'Social Subjects',
}

# S4 Subject Mappings
S4_SUBJECT_MAPPINGS = {
    # Add mappings here as you discover them
    # Example format:
    # 'UNFRIENDLY_NAME': 'Friendly Name',
    'ASN Applications of Maths (NAT4)': 'Applications of Maths (ASN) - (NAT4)',
    'ASN English': 'English (ASN)',
    'ASN Maths (Personal Finance)': 'Personal Finance (ASN)',
    'Accounting (NAT5)': 'Accounting (NAT5)',
    'Admin & IT (NAT4)': 'Admin & IT (NAT4)',
    'Admin & IT (NAT5)': 'Admin & IT (NAT5)',
    'Applications of Maths (NAT5)': 'Applications of Maths (NAT5)',
    'Art & Design (NAT4)': 'Art & Design (NAT4)',
    'Art & Design (NAT5)': 'Art & Design (NAT5)',
    'Biology (NAT4)': 'Biology (NAT4)',
    'Biology (NAT5)': 'Biology (NAT5)',
    'Business (NAT4)': 'Business (NAT4)',
    'Business Management (NAT5)': 'Business Management (NAT5)',
    'CDU study School': 'CDU study School',
    'Chemistry (NAT4)': 'Chemistry (NAT4)',
    'Chemistry (NAT5)': 'Chemistry (NAT5)',
    'College': 'College',
    'Computing Science (NAT4)': 'Computing Science (NAT4)',
    'Computing Science (NAT5)': 'Computing Science (NAT5)',
    'DYW Skills Course': 'DYW Skills Course',
    'Dance (NAT5)': 'Dance (NAT5)',
    'Design & Manufacture (NAT5)': 'Design & Manufacture (NAT5)',
    'Drama (NAT4)': 'Drama (NAT4)',
    'Drama (NAT5)': 'Drama (NAT5)',
    'English (NAT5)': 'English (NAT5)',
    'English (Nat 4)': 'English (NAT4)',
    'English (Nat 5)': 'English (NAT5)',
    'French (NAT5)': 'French (NAT5)',
    'French (Nat 4)': 'French (NAT4)',
    'French (Nat 5)': 'French (NAT5)',
    'Geography (NAT4)': 'Geography (NAT4)',
    'Geography (NAT5)': 'Geography (NAT5)',
    'Graphic Communication (NAT4)': 'Graphic Communication (NAT4)',
    'Graphic Communication (NAT5)': 'Graphic Communication (NAT5)',
    'History (NAT4)': 'History (NAT4)',
    'History (NAT5)': 'History (NAT5)',
    'Mandarin (NAT5)': 'Mandarin (NAT5)',
    'Mathematics (NAT4)': 'Mathematics (NAT4)',
    'Mathematics (NAT5)': 'Mathematics (NAT5)',
    'Mathematics (Nat 4)': 'Mathematics (Nat 4)',
    'Modern Studies (NAT4)': 'Modern Studies (NAT4)',
    'Modern Studies (NAT5)': 'Modern Studies (NAT5)',
    'Music (NAT4)': 'Music (NAT4)',
    'Music (NAT5)': 'Music (NAT5)',
    'PE (NAT4)': 'PE (NAT4)',
    'PE (NAT5)': 'PE (NAT5)',
    'Photography (SCQF4)': 'Photography (SCQF L4)',
    'Photography (SCQF5)': 'Photography (SCQF L5)',
    'Physics (NAT4)': 'Physics (NAT4)',
    'Physics (NAT5)': 'Physics (NAT5)',
    'Practical Cookery (NAT4)': 'Practical Cookery (NAT4)',
    'Practical Cookery (NAT5)': 'Practical Cookery (NAT5)',
    'Practical Metalwork (NAT5)': 'Practical Metalwork (NAT5)',
    'Practical Woodwork (NAT5)': 'Practical Woodwork (NAT5)',
    'RMPS (NAT4)': 'RMPS (NAT4)',
    'RMPS (NAT5)': 'RMPS (NAT5)',
    'Spanish (NAT4)': 'Spanish (NAT4)',
    'Spanish (NAT5)': 'Spanish (NAT5)',
    'punj': 'Punj',
    'Applications of Maths (Nat4)': 'Applications of Maths (Nat4)',
    'College': 'College',
    'DYW': 'DYW',
    'Design & Manufacture (Nat4)': 'Design & Manufacture (NAT4)',
    'English (Nat4)': 'English (NAT4)',
    'Graphic Communications (Nat4)': 'Graphic Communications (NAT4)',
    'Graphic Communications (Nat5)': 'Graphic Communications (NAT5)',
    'Health Science (Nat4)': 'Health Science (NAT4)',
    'Health Science (Nat5)': 'Health Science (NAT5)',
    'Metalwork': 'Metalwork',
    'Metalwork (Nat4)': 'Metalwork (NAT4)',
    'Metalwork (Nat5)': 'Metalwork (NAT5)',
    'Photography (Level 5)': 'Photography (SCQF L5)',
    'Physical Education (Nat4)': 'Physical Education (NAT4)',
    'Physical Education (Nat5)': 'Physical Education (NAT5)',
    'Woodwork (Nat4)': 'Practical Woodwork (NAT4)',
    'Woodwork (Nat5)': 'Practical Woodwork (NAT5)',
    'Accounting (Nat 5)': 'Accounting (NAT5)',
    'Administration and IT (Nat 4)': 'Admin and IT (NAT4)',
    'Administration and IT (Nat 5)': 'Admin and IT (NAT5)',
    'Applications of Mathematics (NAT5)': 'Applications of Maths (NAT5)',
    'Applications of Mathematics (Nat 4)': 'Applications of Maths (NAT4)',
    'Art and Design (Nat 4)': 'Art and Design (NAT4)',
    'Art and Design (Nat 5)': 'Art and Design (NAT5)',
    'Biology (Nat 4)': 'Biology (NAT4)',
    'Biology (Nat 5)': 'Biology (NAT5)',
    'Business Management (Nat 4)': 'Business Management (NAT4)',
    'Business Management (Nat 5)': 'Business Management (NAT5)',
    'Chemistry (Nat 4)': 'Chemistry (NAT4)',
    'Chemistry (Nat 5)': 'Chemistry (NAT5)',
    'College/DYW': 'College/DYW',
    'Computing Science (Nat 4)': 'Computing Science (NAT4)',
    'Computing Science (Nat 5)': 'Computing Science (NAT5)',
    'Dance (Nat 5)': 'Dance (NAT5)',
    'Design and Manufacture (Nat 5)': 'Design and Manufacture (NAT5)',
    'Drama (Nat 4)': 'Drama (NAT4)',
    'Drama (Nat 5)': 'Drama (NAT5)',
    'Early Learning and Childcare (Nat 5)': 'Early Learning and Childcare (NAT5)',
    'Fashion and Textile Technologies (Nat 5)': 'Fashion and Textiles (NAT5)',
    'Fashion and Textiles Technologies (Nat 4)': 'Fashion and Textiles (NAT4)',
    'Geography (Nat 4)': 'Geography (NAT4)',
    'Geography (Nat 5)': 'Geography (NAT5)',
    'Graphic Communication (Nat 4)': 'Graphic Communication (NAT4)',
    'Graphic Communication (Nat 5)': 'Graphic Communication (NAT5)',
    'Health Sector (Nat 4)': 'Health Sector (NAT4)',
    'Health Sector (Nat 5)': 'Health Sector (NAT5)',
    'History (Nat 4)': 'History (NAT4)',
    'History (Nat 5)': 'History (NAT5)',
    'Mandarin (Nat 5)': 'Mandarin (NAT5)',
    'Metalwork (Nat 4)': 'Metalwork (NAT4)',
    'Metalwork (Nat 5)': 'Metalwork (NAT5)',
    'Modern Studies (Nat 4)': 'Modern Studies (NAT4)',
    'Modern Studies (Nat 5)': 'Modern Studies (NAT5)',
    'Music (Nat 4)': 'Music (NAT4)',
    'Music (Nat 5)': 'Music (NAT5)',
    'PE (Nat 4)': 'PE (NAT4)',
    'PE (Nat 5)': 'PE (NAT5)',
    'Photography (SCQF L4)': 'Photography (SCQF L4)',
    'Photography (SCQF L5)': 'Photography (SCQF L5)',
    'Physics (Nat 4)': 'Physics (NAT4)',
    'Physics (Nat 5)': 'Physics (NAT5)',
    'Practical Cookery (Nat 4)': 'Practical Cookery (NAT4)',
    'Practical Cookery (Nat 5)': 'Practical Cookery (NAT5)',
    'Spanish (Nat 4)': 'Spanish (NAT4)',
    'Spanish (Nat 5)': 'Spanish (NAT5)',
    'Woodwork (Nat 4)': 'Woodwork (NAT4)',
    'Woodwork (Nat 5)': 'Woodwork (NAT5)',
    'Accounting (NAT5)': 'Accounting (NAT5)',
    'Admin & IT (NAT4)': 'Admin & IT (NAT4)',
    'Admin & IT (NAT5)': 'Admin & IT (NAT5)',
    'Applications of Maths (ASN Dept)': 'Applications of Maths (ASN)',
    'Applications of Maths (NAT5)': 'Applications of Maths (NAT5)',
    'Art & Design (ASN)': 'Art and Design (ASN)',
    'Art & Design (NAT4)': 'Art and Design (NAT4)',
    'Art & Design (NAT5)': 'Art and Design (NAT5)',
    'Biology (ASN)': 'Biology (ASN)',
    'Biology (NAT4)': 'Biology (NAT4)',
    'Biology (NAT5)': 'Biology (NAT5)',
    'Business (NAT4)': 'Business (NAT4)',
    'Business Management (NAT5)': 'Business Management (NAT5)',
    'Chemistry (NAT4)': 'Chemistry (NAT4)',
    'Chemistry (NAT5)': 'Chemistry (NAT5)',
    'College': 'College',
    'Computing Science (NAT4)': 'Computing Science (NAT4)',
    'Computing Science (NAT5)': 'Computing Science (NAT5)',
    'Criminology (Level 5)': 'Criminology (Level 5)',
    'DYW': 'DYW',
    'Dance (NAT5)': 'Dance (NAT5)',
    'Design and Manufacture': 'Design and Manufacture (NAT5)',
    'Design and Manufacture (NAT4)': 'Design and Manufacture (NAT4)',
    'Drama (ASN)': 'Drama (ASN)',
    'Drama (NAT4)': 'Drama (NAT4)',
    'Drama (NAT5)': 'Drama (NAT5)',
    'Early Learning and Childcare (Level 5)': 'Early Learning and Childcare (Level 5)',
    'Economics (NAT5)': 'Economics (NAT5)',
    'English (ASN Dept)': 'English (ASN)',
    'English (NAT4)': 'English (NAT4)',
    'English (NAT5)': 'English (NAT5)',
    'Fashion & Textiles (NAT4)': 'Fashion and Textiles (NAT4)',
    'Fashion and Textiles (NAT5)': 'Fashion and Textiles (NAT5)',
    'French (NAT4)': 'French (NAT4)',
    'French (NAT5)': 'French (NAT5)',
    'Geography (ASN)': 'Geography (ASN)',
    'Geography (NAT4)': 'Geography (NAT4)',
    'Geography (NAT5)': 'Geography (NAT5)',
    'Graphic Communication (NAT4)': 'Graphic Communication (NAT4)',
    'Graphic Communication (NAT5)': 'Graphic Communication (NAT5)',
    'HE (ASN)': 'HE (ASN)',
    'Health Sector (NAT4)': 'Health Sector (NAT4)',
    'Health Sector (NAT5)': 'Health Sector (NAT5)',
    'History (ASN)': 'History (ASN)',
    'History (NAT4)': 'History (NAT4)',
    'History (NAT5)': 'History (NAT5)',
    'ICT (ASN)': 'ICT (ASN)',
    'Mandarin (NAT5)': 'Mandarin (NAT5)',
    'Maths (NAT5)': 'Mathematics (NAT5)',
    'Metalwork (NAT4)': 'Practical Metalwork (NAT4)',
    'Metalwork (NAT5)': 'Practical Metalwork (NAT5)',
    'Modern Studies (ASN)': 'Modern Studies (ASN)',
    'Modern Studies (NAT4)': 'Modern Studies (NAT4)',
    'Modern Studies (NAT5)': 'Modern Studies (NAT5)',
    'Music (ASN)': 'Music (ASN)',
    'Music (NAT4)': 'Music (NAT4)',
    'Music (NAT5)': 'Music (NAT5)',
    'PE (SQA) - (ASN)': 'PE (SQA) - (ASN)',
    'PE (SQA) - (NAT4)': 'PE (SQA) - (NAT4)',
    'PE (SQA) - (NAT5)': 'PE (SQA) - (NAT5)',
    'Photography (Level 4)': 'Photography (Level 4)',
    'Physics (NAT4)': 'Physics (NAT4)',
    'Physics (NAT5)': 'Physics (NAT5)',
    'Practical Cookery (NAT4)': 'Practical Cookery (NAT4)',
    'Practical Cookery (NAT5)': 'Practical Cookery (NAT5)',
    'Spanish (NAT5)': 'Spanish (NAT5)',
}

# S5-6 Subject Mappings
S5_S6_SUBJECT_MAPPINGS = {
    # Add mappings here as you discover them
    # Example format:
    # 'UNFRIENDLY_NAME': 'Friendly Name',
}

# Master mapping dictionary
YEAR_GROUP_MAPPINGS = {
    'S3': S3_SUBJECT_MAPPINGS,
    'S4': S4_SUBJECT_MAPPINGS,
    'S5-6': S5_S6_SUBJECT_MAPPINGS,
}


def normalize_subject_name(subject_name, year_group):
    """
    Normalize a subject name using mappings from database and hardcoded dictionaries.
    Database mappings take precedence over hardcoded ones.
    
    Args:
        subject_name (str): The original subject name from the file
        year_group (str): The year group (S3, S4, or S5-6)
    
    Returns:
        str: The friendly name if a mapping exists, otherwise the original name
    """
    if not subject_name or subject_name.strip() == '':
        return None
    
    # Strip whitespace from the subject name
    clean_name = subject_name.strip()
    
    # First check database mappings
    try:
        from app.models import SubjectMapping
        from app import db
        
        db_mapping = SubjectMapping.query.filter(
            SubjectMapping.year_group == year_group,
            db.func.lower(SubjectMapping.unfriendly_name) == clean_name.lower()
        ).first()
        
        if db_mapping:
            return db_mapping.friendly_name
    except:
        # If database not available or error, continue to hardcoded mappings
        pass
    
    # Fall back to hardcoded mappings
    mappings = YEAR_GROUP_MAPPINGS.get(year_group, {})
    
    # Check if there's a mapping (case-insensitive)
    for unfriendly, friendly in mappings.items():
        if clean_name.upper() == unfriendly.upper():
            return friendly
    
    # If no mapping found, return the original cleaned name
    return clean_name


def add_mapping(year_group, unfriendly_name, friendly_name):
    """
    Add a new subject mapping programmatically.
    
    Args:
        year_group (str): The year group (S3, S4, or S5-6)
        unfriendly_name (str): The unfriendly subject name
        friendly_name (str): The friendly subject name
    """
    if year_group in YEAR_GROUP_MAPPINGS:
        YEAR_GROUP_MAPPINGS[year_group][unfriendly_name] = friendly_name
    else:
        raise ValueError(f"Invalid year group: {year_group}. Must be one of: S3, S4, S5-6")


def get_all_mappings(year_group=None):
    """
    Get all subject mappings, optionally filtered by year group.
    
    Args:
        year_group (str, optional): The year group to filter by
    
    Returns:
        dict: The mappings dictionary
    """
    if year_group:
        return YEAR_GROUP_MAPPINGS.get(year_group, {})
    return YEAR_GROUP_MAPPINGS


def save_mappings_to_file(year_group, new_mappings):
    """
    Save new mappings to the database.
    
    Args:
        year_group (str): The year group (S3, S4, or S5-6)
        new_mappings (dict): Dictionary of {unfriendly_name: friendly_name}
    """
    from app import db
    from app.models import SubjectMapping
    
    saved_count = 0
    for unfriendly, friendly in new_mappings.items():
        # Check if mapping already exists
        existing = SubjectMapping.query.filter_by(
            year_group=year_group,
            unfriendly_name=unfriendly
        ).first()
        
        if existing:
            # Update existing mapping
            existing.friendly_name = friendly
            existing.updated_at = db.func.now()
        else:
            # Create new mapping
            new_mapping = SubjectMapping(
                year_group=year_group,
                unfriendly_name=unfriendly,
                friendly_name=friendly
            )
            db.session.add(new_mapping)
        
        # Also add to runtime dictionary
        add_mapping(year_group, unfriendly, friendly)
        saved_count += 1
    
    try:
        db.session.commit()
        return saved_count
    except Exception as e:
        db.session.rollback()
        raise Exception(f"Failed to save mappings to database: {str(e)}")


def save_mappings_to_file_OLD(year_group, new_mappings):
    """
    OLD METHOD: Append new mappings to the subject_mappings.py file.
    This is kept for reference but replaced with database storage.
    
    Args:
        year_group (str): The year group (S3, S4, or S5-6)
        new_mappings (dict): Dictionary of {unfriendly_name: friendly_name}
    """
    import os
    
    # Get the path to this file
    current_file = os.path.abspath(__file__)
    
    # Read the current content
    with open(current_file, 'r', encoding='utf-8') as f:
        lines = f.readlines()
    
    # Fix the variable name mapping for S5-6
    if year_group == 'S5-6':
        mapping_var = 'S5_S6_SUBJECT_MAPPINGS'
    else:
        mapping_var = f"{year_group}_SUBJECT_MAPPINGS"
    
    # Find where to insert (look for the closing brace of the dictionary)
    insert_index = None
    for i, line in enumerate(lines):
        if mapping_var in line and '= {' in line:
            # Find the closing brace
            for j in range(i, len(lines)):
                if lines[j].strip() == '}':
                    insert_index = j
                    break
            break
    
    if insert_index is None:
        raise ValueError(f"Could not find {mapping_var} in file")
    
    # Prepare new mapping lines
    new_lines = []
    for unfriendly, friendly in new_mappings.items():
        # Add to runtime dictionary first
        add_mapping(year_group, unfriendly, friendly)
        
        # Prepare line for file
        new_lines.append(f"    '{unfriendly}': '{friendly}',\n")
    
    # Insert before the closing brace
    lines[insert_index:insert_index] = new_lines
    
    # Write back to file
    with open(current_file, 'w', encoding='utf-8') as f:
        f.writelines(lines)
